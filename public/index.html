<!doctype html>

<!--
    Name of the App : NodeJS Chat Example
    Description : A simple multiroom chat application to showcase Node.js and Socket.io
-->

<html lang="en">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <head>
        <title>Chat Rooms - Home</title>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

        <!-- CSS -->
        <link rel="stylesheet" href="/css/chat.css">

    </head>

    <body>
        <div class="container">
            <div class="row jumbotron">
                <h1>Chat Rooms</h1>

                <p>A simple multiroom chat application to showcase Node.js and Socket.io</p>

            </div>

            <div class="row">
                <div class="col-md-10">
                    <div class="room-header">Welcome <span id='name'></span>, you are in <span id='room-name'>Lobby</span>!</div>

                    <div id="messages"></div>

                    <form id="message-form">
                        <div class="input-group">
                            <div class="input-group-btn">
                                <button id="command-button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">New Message<span class="caret"></span></button>
                                <ul class="dropdown-menu">
                                    <li><a class="command" href="#" placeholder="Enter a message">New Message</a></li>
                                    <li><a class="command" href="#" placeholder="Enter a new room name">New Room</a></li>
                                    <li><a class="command" href="#" placeholder="Enter a new name">Change Name</a></li>
                                </ul>
                            </div>
                            <input type="text" id="message" class="form-control" placeholder="Enter a message">
                            <span class="input-group-btn"><button class="btn btn-default" type="submit">Ok</button></span>
                        </div>
                        <small class="pull-right"> Click OK or Press Enter</small>
                    </form>
                </div>

                 <div class="col-md-2">
                    <div class="room-header">Rooms</div>

                    <div id="room-list"><div class="room selected">Lobby</div></div>

                </div>
            </div>
        </div>

        <!-- Scripts - external -->
        <script src="/socket.io/socket.io.js"></script>  <!-- Socket.io -->
        <script src="//code.jquery.com/jquery-1.11.3.min.js"></script> <!-- jQuery -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> <!-- Bootstrap -->

        <!-- Scripts -->
        <script src="/js/chat.js"></script>
        <script src="/js/chat_client.js"></script>

        <script>
            var socket = io();
            var myName = "";
            var myRoomName = "Lobby";

            function divSys (msg, isErr) {
                var cls = isErr ? 'text-danger' : 'text-info';
                return $("<div class='" + cls + "'></div>").html('<i>' + msg + '</i>');
            }

            function divMsg (msg, usr) {
                return $("<div></div>").html('<span class="text-primary">' + usr + '</span> - ' + msg);
            }

            function appendMsg(msg, sender, isErr) {
                $appendDiv = sender ? divMsg(msg, sender) : divSys(msg, isErr);
                $('#messages').append($appendDiv);
                $('#messages').scrollTop($('#messages').prop('scrollHeight'));
            }

            function newMessage() {
                var msg = $('#message').val();
                if(msg) {
                    $('#message').val('');
                    socket.emit('new msg', msg);
                    appendMsg(msg, myName);
                } else {
                    $('#message').focus();
                }
            }

            function newRoom() {
                var roomName = $('#message').val();
                if(roomName) {
                    joinRoom(roomName);
                } else {
                    $('#message').focus();
                }
            }

             function changeName() {
                var newName = $('#message').val();
                if(newName) {
                    socket.emit('change name', newName);
                } else {
                    $('#message').focus();
                }
            }

            function joinRoom(name) {
                if(name) {
                    socket.emit('join room', name);
                    setTimeout(1000);
                    socket.emit('rooms');
                }
            }

            function updateRooms(rooms) {
                console.log("Rooms : " + rooms.join(', '));
                var $divRoom, roomName;

                $('#room-list').html('');
                for(var i =0; i < rooms.length; i++) {
                    $divRoom = $("<div class='room'></div>").text(rooms[i]);
                    $divRoom.on('click', function() {
                        console.log($(this).text());
                        joinRoom($(this).text());
                    });
                    if(rooms[i] === myRoomName) $divRoom.addClass('selected');
                    $("#room-list").append($divRoom);
                }
            }

            function updateCommandBtnText(text, placeholder) {
                $('#command-button').html(text + '<span class="caret"></span>');
                $('#message').attr('placeholder', placeholder);
            }

            $(function() {
                socket.on('new name', function(newClientName) {
                    myName = newClientName;
                    $('#name').text(myName);
                    appendMsg('Hello, your assigned name is ' + myName);
                    socket.emit('rooms');
                });

                socket.on('disconnect', function(clientName) {
                    appendMsg('User ' + clientName + ' has left Chat rooms!');
                });

                socket.on('user joined room', function(clientName) {
                    appendMsg('User ' + clientName + ' has joined!');
                });

                socket.on('user left room', function(clientName) {
                    appendMsg('User ' + clientName + ' has left!');
                });

                socket.on('room joined', function(roomName) {
                    myRoomName = roomName;
                    $('#room-name').text(myRoomName);
                    appendMsg('You have joined ' + roomName + '!');
                    socket.emit('new msg', "Hello everybody from " + myName);
                });

                socket.on('user new msg', function(msg) {
                    appendMsg(msg.text,msg.name);
                });

                socket.on('same name', function(clientName) {
                    appendMsg("Your name is already " + clientName, isErr=true);
                });

                socket.on('name taken', function(newClientName) {
                    appendMsg(newClientName + " is already taken! Please try another name", isErr=true);
                    if(newClientName == "Guest1") {
                        socket.emit('change name', 'Vikram');
                    }
                    if(newClientName == "Vikram") {
                        socket.emit('change name', 'Shwetha');
                    }
                    else if(newClientName == "Shwetha") {
                        socket.emit('change name', 'Ritwik');
                    }

                });

                socket.on('name invalid guest', function(newClientName) {
                    appendMsg(newClientName + " : Client Name starts with 'Guest' and is invalid! Try another name", isErr=true);
                    socket.emit('change name', 'Vikram');
                });

                socket.on('name changed', function(newClientName) {
                    myName = newClientName;
                    $('#name').text(myName);
                    appendMsg('Name changed to ' + newClientName + ' successfully!');

                    if(newClientName === "Vikram" || newClientName === "Ritwik")
                        socket.emit('join room', "Room 1");

                    socket.emit('rooms');
                });

                socket.on('user name changed', function(message) {
                    appendMsg('User ' + message.oldName + "'s name is changed to " + message.newName + "!");
                });

                socket.on('same room', function(clientName) {
                    appendMsg("You are already in room : " + clientName, isErr=true);

                });
                
                $("#message-form").submit(function(e) {
                    var cmdBtnText = $('#command-button').text();
                    switch(cmdBtnText) {
                        case 'New Message':
                            newMessage();
                            break;
                        case 'New Room':
                            newRoom();
                            break;
                        case 'Change Name':
                            changeName();
                            break;
                    }
                    e.preventDefault();
                });

                socket.on('rooms list', updateRooms);

                setInterval(function() { socket.emit('rooms'); }, 20000);

                $('.command').on('click', function() {
                    updateCommandBtnText($(this).text(), $(this).attr('placeholder'));
                });
            });
        
        </script>
    </body>
</html>
